<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Process Visualizer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .input-section {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .input-section h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.4rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .test-btn:hover {
            background-color: #2980b9;
        }
        
        textarea {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 20px;
        }
        
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .process-btn {
            padding: 12px 30px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .process-btn:hover {
            background-color: #27ae60;
        }
        
        .reset-btn {
            padding: 12px 30px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        .progress-section {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .error-section {
            background-color: #fde8e8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .error-message {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .close-error {
            float: right;
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 18px;
        }
        
        .results-section {
            margin-top: 40px;
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-card h2:before {
            content: "►";
            color: #3498db;
            font-size: 0.9em;
        }
        
        .highlighted-text {
            font-family: Arial, sans-serif;
            line-height: 2.0;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            overflow-wrap: break-word;
        }
        
        .entity {
            background-color: #7FDBFF;
            padding: 4px 8px;
            margin: 4px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .entity-task {
            background-color: #FFDC00;
        }
        
        .entity-condition {
            background-color: #FF851B;
        }
        
        .entity-task-info {
            background-color: #2ECC40;
        }
        
        .entity-o {
            background-color: #DDDDDD;
        }
        
        .entity-label {
            font-size: 0.8em;
            opacity: 0.6;
        }
        
        .plantuml-text {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .visualization-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .visualization {
            width: 100%;
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }
        
        .visualization-placeholder {
            color: #7f8c8d;
            text-align: center;
            padding: 40px;
        }
        
        .status-message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        
        .status-loading {
            background-color: #e8f4fd;
            color: #3498db;
            border: 1px solid #3498db;
        }
        
        .status-error {
            background-color: #fde8e8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status-success {
            background-color: #e8f8ef;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .url-link {
            display: block;
            margin-top: 15px;
            color: #3498db;
            word-break: break-all;
            text-decoration: none;
        }
        
        .url-link:hover {
            text-decoration: underline;
        }
        
        .heatmap-container, .sankey-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .matrix-display {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .test-buttons, .main-buttons {
                flex-direction: column;
            }
            
            .test-btn, .process-btn, .reset-btn {
                width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .input-section, .result-card {
                padding: 15px;
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- PlantUML Encoder -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>BPMN Process Visualizer</h1>
        
        <div class="input-section">
            <h2>Enter process text:</h2>
            
            <div class="test-buttons">
                <button class="test-btn" data-test="1">Test 1: Simple process</button>
                <button class="test-btn" data-test="2">Test 2: Conditional process</button>
                <button class="test-btn" data-test="3">Test 3: Complex multi-participant process</button>
            </div>
            
            <textarea id="process-text" placeholder="Enter business process description here..."></textarea>
            
            <div class="main-buttons">
                <button id="process-btn" class="process-btn">Process Text</button>
                <button id="reset-btn" class="reset-btn">Reset</button>
            </div>
            
            <div class="progress-section" id="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">Processing...</div>
            </div>
            
            <div class="error-section" id="error-section">
                <button class="close-error" id="close-error">×</button>
                <div class="error-title">Error</div>
                <div class="error-message" id="error-message"></div>
            </div>
        </div>
        
        <div id="status-message" class="status-message"></div>
        
        <div class="results-section">
            <div id="result-highlighting" class="result-card" style="display: none;">
                <h2>=== ENTITY HIGHLIGHTING ===</h2>
                <div id="highlighted-text" class="highlighted-text">
                    Entity highlighting result will appear here...
                </div>
            </div>
            
            <div id="result-plantuml" class="result-card" style="display: none;">
                <h2>=== PLANTUML BPMN ===</h2>
                <div id="plantuml-text" class="plantuml-text"></div>
                <div id="plantuml-image" class="visualization">
                    <div class="visualization-placeholder">
                        BPMN diagram will be displayed here
                    </div>
                </div>
                <a id="plantuml-url" class="url-link" href="#" target="_blank" style="display: none;"></a>
            </div>
            
            <div id="result-heatmap" class="result-card" style="display: none;">
                <h2>=== INTERACTION MATRIX + HEATMAP ===</h2>
                <div id="matrix-text" class="matrix-display"></div>
                <div id="heatmap-visualization" class="visualization">
                    <div class="visualization-placeholder">
                        Interaction heatmap will be displayed here
                    </div>
                </div>
            </div>
            
            <div id="result-sankey" class="result-card" style="display: none;">
                <h2>=== SANKEY DIAGRAM ===</h2>
                <div id="sankey-visualization" class="visualization">
                    <div class="visualization-placeholder">
                        Sankey diagram will be displayed here
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test data in English
        const testCases = {
            1: `Employee submits a vacation request. Manager reviews the request. If approved, HR department processes the vacation. Otherwise, manager informs the employee.`,
            
            2: `Customer submits a product return request. Support service checks the request. If product meets return conditions, finance department approves refund, system processes payment. Otherwise, support service informs customer about rejection.`,
            
            3: `Customer sends development request. Project manager analyzes the request. If request matches company capabilities, sales department prepares commercial proposal, technical department estimates timelines. If proposal accepted, development department starts work, testers verify result. Otherwise, project manager informs customer about refusal.`
        };

        // Initialize test buttons
        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', function() {
                const testNumber = this.getAttribute('data-test');
                document.getElementById('process-text').value = testCases[testNumber];
                showStatus(`Loaded test case ${testNumber}`, 'success');
            });
        });

        // Process button
        document.getElementById('process-btn').addEventListener('click', processText);
        
        // Reset button
        document.getElementById('reset-btn').addEventListener('click', resetApp);
        
        // Close error button
        document.getElementById('close-error').addEventListener('click', () => {
            document.getElementById('error-section').style.display = 'none';
        });
        
        // Function to process text
        async function processText() {
            const text = document.getElementById('process-text').value.trim();
            
            if (!text) {
                showError('Please enter process text');
                return;
            }
            
            // Reset previous state
            hideAllResults();
            hideError();
            hideStatus();
            
            // Show progress bar
            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            progressSection.style.display = 'block';
            
            try {
                // Simulate processing with progress updates
                await simulateProcessing(progressBar, progressText);
                
                // Generate demo results
                generateDemoResults(text);
                
                // Show success
                showStatus('Processing completed successfully!', 'success');
                
            } catch (error) {
                showError(`Processing error: ${error.message}`);
            } finally {
                // Hide progress bar after delay
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 500);
            }
        }
        
        // Simulate processing with progress
        async function simulateProcessing(progressBar, progressText) {
            const steps = [
                {percent: 10, text: "Parsing text..."},
                {percent: 25, text: "Extracting entities..."},
                {percent: 40, text: "Identifying process participants..."},
                {percent: 60, text: "Generating BPMN diagram..."},
                {percent: 80, text: "Creating visualizations..."},
                {percent: 95, text: "Finalizing results..."},
                {percent: 100, text: "Complete!"}
            ];
            
            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 400));
                progressBar.style.width = step.percent + '%';
                progressText.textContent = step.text;
            }
        }
        
        // Show error
        function showError(message) {
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
            
            // Auto-hide error after 10 seconds
            setTimeout(() => {
                errorSection.style.display = 'none';
            }, 10000);
        }
        
        // Hide error
        function hideError() {
            document.getElementById('error-section').style.display = 'none';
        }
        
        // Reset function
        function resetApp() {
            document.getElementById('process-text').value = '';
            hideAllResults();
            hideStatus();
            hideError();
            document.getElementById('progress-section').style.display = 'none';
            showStatus('Application reset', 'success');
            setTimeout(hideStatus, 2000);
        }
        
        // Hide all results
        function hideAllResults() {
            const resultCards = document.querySelectorAll('.result-card');
            resultCards.forEach(card => {
                card.style.display = 'none';
            });
        }
        
        // Show status
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'loading') {
                statusEl.innerHTML = `<span class="loading-spinner"></span> ${message}`;
            }
        }
        
        // Hide status
        function hideStatus() {
            document.getElementById('status-message').style.display = 'none';
        }
        
        // Generate demo results
        function generateDemoResults(text) {
            try {
                // Extract entities
                const entities = extractEntities(text);
                
                // Show entity highlighting
                showEntityHighlighting(entities);
                
                // Generate PlantUML text
                const plantumlText = generatePlantUML(text);
                showPlantUML(plantumlText);
                
                // Generate interaction matrix and heatmap
                const agents = extractAgents(text);
                showInteractionMatrix(agents);
                generateHeatmap(agents);
                
                // Generate Sankey diagram
                generateSankey(agents);
                
            } catch (error) {
                showError(`Failed to generate results: ${error.message}`);
            }
        }
        
        // Extract entities from text
        function extractEntities(text) {
            const entities = [];
            const words = text.split(/\s+/);
            
            // Simple entity extraction logic
            words.forEach(word => {
                const cleanWord = word.replace(/[.,]/g, '').toLowerCase();
                
                if (['department', 'service', 'employee', 'customer', 'manager', 'client', 'tester'].some(term => cleanWord.includes(term))) {
                    entities.push({text: word, type: 'AGENT'});
                } else if (['submits', 'reviews', 'checks', 'analyzes', 'prepares', 'estimates', 'starts', 'processes', 'informs', 'verifies'].some(term => cleanWord.includes(term))) {
                    entities.push({text: word, type: 'TASK'});
                } else if (['if', 'otherwise'].includes(cleanWord)) {
                    entities.push({text: word, type: 'CONDITION'});
                } else {
                    entities.push({text: word, type: 'O'});
                }
            });
            
            return entities;
        }
        
        // Extract participants from text
        function extractAgents(text) {
            const agents = [];
            const sentences = text.split(/[.,]/g);
            
            sentences.forEach(sentence => {
                if (sentence.includes('department') || sentence.includes('service') || sentence.includes('employee') || 
                    sentence.includes('customer') || sentence.includes('manager') || sentence.includes('client')) {
                    
                    // Simplified agent extraction
                    const words = sentence.trim().split(/\s+/);
                    if (words.length > 0) {
                        const agent = words.slice(0, Math.min(3, words.length)).join(' ');
                        if (agent && !agents.includes(agent)) {
                            agents.push(agent);
                        }
                    }
                }
            });
            
            // If no agents found, create demo agents
            if (agents.length === 0) {
                return ['Employee', 'Manager', 'HR Department', 'Finance Department'];
            }
            
            return agents;
        }
        
        // Show entity highlighting
        function showEntityHighlighting(entities) {
            const container = document.getElementById('highlighted-text');
            let html = '';
            
            // Group entities for better display
            let currentGroup = [];
            let currentType = null;
            
            entities.forEach((entity, index) => {
                if (entity.type !== currentType && currentGroup.length > 0) {
                    html += createEntitySpan(currentGroup.join(' '), currentType);
                    currentGroup = [];
                }
                
                currentGroup.push(entity.text);
                currentType = entity.type;
                
                // If last entity, output group
                if (index === entities.length - 1) {
                    html += createEntitySpan(currentGroup.join(' '), currentType);
                }
            });
            
            container.innerHTML = html;
            document.getElementById('result-highlighting').style.display = 'block';
        }
        
        // Create entity span
        function createEntitySpan(text, type) {
            const typeClass = `entity-${type.toLowerCase()}`;
            const displayType = type !== 'O' ? type : '';
            
            return `
                <span class="entity ${typeClass}">
                    ${text}
                    ${displayType ? `<span class="entity-label">${displayType}</span>` : ''}
                </span>
            `;
        }
        
        // Generate PlantUML text - CORRECT SYNTAX
        function generatePlantUML(text) {
            const agents = extractAgents(text);
            const hasCondition = text.toLowerCase().includes('if') || text.toLowerCase().includes('otherwise');
            
            let plantuml = `@startuml\n`;
            plantuml += `title Business Process Diagram\n\n`;
            
            // Get unique agents
            const uniqueAgents = [...new Set(agents.map(agent => 
                agent.split(' ').slice(0, 2).join(' ')
            ))].slice(0, 4);
            
            if (uniqueAgents.length === 0) {
                uniqueAgents.push('Employee', 'Manager', 'HR Department');
            }
            
            // Add participants with simple names
            uniqueAgents.forEach((agent, index) => {
                // Clean name for PlantUML
                const cleanName = agent.length > 20 ? agent.substring(0, 20) + "..." : agent;
                plantuml += `participant "${cleanName}" as P${index}\n`;
            });
            
            plantuml += `\n`;
            
            // Add process flow
            if (uniqueAgents.length >= 2) {
                plantuml += `P0 -> P1 : Submit request\n`;
                if (uniqueAgents.length >= 3) {
                    plantuml += `P1 -> P2 : Review request\n`;
                }
            }
            
            // Add conditional flow - CORRECT PlantUML syntax
            if (hasCondition) {
                plantuml += `\n`;
                plantuml += `alt Request approved\n`;
                
                if (uniqueAgents.length >= 3) {
                    plantuml += `  P2 -> P0 : Process\n`;
                } else if (uniqueAgents.length >= 2) {
                    plantuml += `  P1 -> P0 : Process\n`;
                }
                
                plantuml += `else Request rejected\n`;
                if (uniqueAgents.length >= 2) {
                    plantuml += `  P1 -> P0 : Inform\n`;
                } else {
                    plantuml += `  P0 -> P0 : Inform\n`;
                }
                plantuml += `end\n`;
            }
            
            plantuml += `\n@enduml`;
            
            return plantuml;
        }
        
        // Show PlantUML with CORRECT ENCODING
        function showPlantUML(plantumlText) {
            document.getElementById('plantuml-text').textContent = plantumlText;
            
            try {
                // CORRECT PlantUML encoding with ~1 prefix
                const encoded = encodePlantUMLCorrect(plantumlText);
                const url = `https://www.plantuml.com/plantuml/svg/${encoded}`;
                
                console.log("Generated PlantUML URL:", url);
                
                // Create image container
                const imgContainer = document.getElementById('plantuml-image');
                imgContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: white; border-radius: 4px;">
                        <img src="${url}" 
                             alt="BPMN Diagram" 
                             style="max-width: 100%; max-height: 500px; border: 1px solid #ddd;"
                             onload="console.log('PlantUML image loaded successfully')"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:40px;color:#666;\\'><strong>⚠️ Diagram Preview</strong><br>View directly: <a href=\\'${url}\\' target=\\'_blank\\'>Open PlantUML ↗</a><br><small>Or copy PlantUML code above to <a href=\\'https://plantuml.com/\\' target=\\'_blank\\'>plantuml.com</a></small></div>'">
                    </div>`;
                
                // Show URL link
                const urlLink = document.getElementById('plantuml-url');
                urlLink.href = url;
                urlLink.textContent = "Open PlantUML diagram in new tab ↗";
                urlLink.style.display = 'block';
                
                document.getElementById('result-plantuml').style.display = 'block';
                
            } catch (error) {
                console.error("PlantUML generation error:", error);
                const imgContainer = document.getElementById('plantuml-image');
                imgContainer.innerHTML = `<div class="visualization-placeholder" style="color:#e74c3c">
                    <strong>Error generating diagram preview</strong><br>
                    <small>Try copying the PlantUML code above to <a href="https://plantuml.com/" target="_blank">plantuml.com</a></small>
                </div>`;
                document.getElementById('result-plantuml').style.display = 'block';
            }
        }
        
        // CORRECT PlantUML encoding function
        function encodePlantUMLCorrect(text) {
            try {
                // Convert text to UTF-8 bytes
                const utf8Bytes = new TextEncoder().encode(text);
                
                // Use pako for DEFLATE compression if available
                let compressed;
                if (typeof pako !== 'undefined') {
                    compressed = pako.deflate(utf8Bytes, { level: 9 });
                } else {
                    // Simple fallback compression
                    compressed = simpleDeflate(utf8Bytes);
                }
                
                // Convert to base64
                let binary = '';
                for (let i = 0; i < compressed.length; i++) {
                    binary += String.fromCharCode(compressed[i]);
                }
                const base64 = btoa(binary);
                
                // Convert to PlantUML format
                const encoded = base64
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
                
                // ADD ~1 prefix for Huffman encoding (as per PlantUML error message)
                return '~1' + encoded;
                
            } catch (error) {
                console.error("Encoding error, using simple encoding:", error);
                // Fallback: simple base64 encoding
                const base64 = btoa(encodeURIComponent(text).replace(/%([0-9A-F]{2})/g, 
                    (match, p1) => String.fromCharCode('0x' + p1)));
                const encoded = base64
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
                return '~1' + encoded;
            }
        }
        
        // Simple DEFLATE compression fallback
        function simpleDeflate(bytes) {
            // Very simple compression for PlantUML
            const result = [];
            
            // DEFLATE header (zlib format)
            result.push(0x78, 0x9C); // CMF (0x78 = deflate, 32k window), FLG (0x9C = default compression)
            
            // Add compressed data (simplified)
            let i = 0;
            while (i < bytes.length) {
                // Find repeated bytes
                let repeatCount = 1;
                while (i + repeatCount < bytes.length && 
                       bytes[i + repeatCount] === bytes[i] && 
                       repeatCount < 258) {
                    repeatCount++;
                }
                
                if (repeatCount > 3) {
                    // Literal block with repeat
                    result.push(bytes[i]);
                    result.push(bytes[i]);
                    result.push(repeatCount);
                    i += repeatCount;
                } else {
                    // Add literals
                    for (let j = 0; j < repeatCount; j++) {
                        result.push(bytes[i + j]);
                    }
                    i += repeatCount;
                }
            }
            
            // Add Adler-32 checksum (simplified)
            result.push(0x00, 0x00, 0x00, 0x01);
            
            return result;
        }
        
        // Show interaction matrix
        function showInteractionMatrix(agents) {
            if (agents.length === 0) return;
            
            // Clean agent names
            const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 2).join(' '));
            
            // Create matrix
            let matrixText = 'Participants: ' + cleanAgents.join(', ') + '\n\n';
            matrixText += 'Interaction Matrix:\n';
            
            for (let i = 0; i < cleanAgents.length; i++) {
                let row = '';
                for (let j = 0; j < cleanAgents.length; j++) {
                    if (i === j) {
                        row += '  0';
                    } else {
                        row += '  ' + Math.floor(Math.random() * 3);
                    }
                }
                matrixText += '[' + row + '  ]\n';
            }
            
            document.getElementById('matrix-text').textContent = matrixText;
        }
        
        // Generate heatmap
        function generateHeatmap(agents) {
            if (agents.length === 0) {
                document.getElementById('result-heatmap').style.display = 'block';
                return;
            }
            
            try {
                // Clean agent names
                const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 2).join(' '));
                
                // Create data
                const data = [];
                for (let i = 0; i < cleanAgents.length; i++) {
                    const row = [];
                    for (let j = 0; j < cleanAgents.length; j++) {
                        row.push(i === j ? 0 : Math.floor(Math.random() * 5));
                    }
                    data.push(row);
                }
                
                const trace = {
                    z: data,
                    x: cleanAgents,
                    y: cleanAgents,
                    type: 'heatmap',
                    colorscale: 'Viridis'
                };
                
                const layout = {
                    title: 'Interaction Heatmap',
                    xaxis: { title: 'To' },
                    yaxis: { title: 'From' },
                    width: document.getElementById('heatmap-visualization').offsetWidth - 40,
                    height: 400
                };
                
                Plotly.newPlot('heatmap-visualization', [trace], layout);
                document.getElementById('result-heatmap').style.display = 'block';
            } catch (error) {
                const container = document.getElementById('heatmap-visualization');
                container.innerHTML = `<div class="visualization-placeholder" style="color:#e74c3c">Heatmap error</div>`;
                document.getElementById('result-heatmap').style.display = 'block';
            }
        }
        
        // Generate Sankey diagram
        function generateSankey(agents) {
            if (agents.length < 2) {
                document.getElementById('result-sankey').style.display = 'block';
                return;
            }
            
            try {
                // Clean agent names
                const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 2).join(' '));
                
                // Create data
                const sources = [];
                const targets = [];
                const values = [];
                
                for (let i = 0; i < cleanAgents.length - 1; i++) {
                    sources.push(i);
                    targets.push(i + 1);
                    values.push(Math.floor(Math.random() * 10) + 1);
                }
                
                const trace = {
                    type: "sankey",
                    orientation: "h",
                    node: {
                        pad: 15,
                        thickness: 20,
                        line: { color: "black", width: 0.5 },
                        label: cleanAgents,
                        color: ["#3498db", "#2ecc71", "#e74c3c", "#f39c12"]
                    },
                    link: {
                        source: sources,
                        target: targets,
                        value: values
                    }
                };
                
                const layout = {
                    title: "Resource Flow",
                    font: { size: 12 },
                    width: document.getElementById('sankey-visualization').offsetWidth - 40,
                    height: 500
                };
                
                Plotly.newPlot('sankey-visualization', [trace], layout);
                document.getElementById('result-sankey').style.display = 'block';
            } catch (error) {
                const container = document.getElementById('sankey-visualization');
                container.innerHTML = `<div class="visualization-placeholder" style="color:#e74c3c">Sankey error</div>`;
                document.getElementById('result-sankey').style.display = 'block';
            }
        }
        
        // Initialize with test text
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('process-text').value = testCases[1];
        });
    </script>
</body>

</html>
