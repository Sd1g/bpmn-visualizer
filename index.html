<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Process Visualizer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .background-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }
        
        .main-container {
            max-width: 2000px;
            margin: 0 auto;
            padding: 30px;
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 40px;
            color: #2c3e50;
            padding: 40px 0 20px;
            font-size: 3.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .input-section {
            padding: 50px;
            margin-bottom: 50px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .input-section h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .input-section h2:before {
            content: "üìù";
            font-size: 1.8rem;
        }
        
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1200px) {
            .test-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .test-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        .test-btn {
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .test-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }
        
        .test-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.5);
        }
        
        .test-btn:hover:before {
            left: 100%;
        }
        
        textarea {
            width: 100%;
            min-height: 250px;
            padding: 30px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 18px;
            line-height: 1.8;
            resize: vertical;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s;
            box-shadow: inset 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1), inset 0 4px 15px rgba(0, 0, 0, 0.05);
            background: white;
        }
        
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
        }
        
        .process-btn {
            padding: 25px 60px;
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 22px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 176, 155, 0.3);
            min-width: 250px;
        }
        
        .process-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }
        
        .process-btn:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 25px 50px rgba(0, 176, 155, 0.5);
        }
        
        .process-btn:hover:before {
            left: 100%;
        }
        
        .reset-btn {
            padding: 25px 60px;
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 22px;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(255, 65, 108, 0.3);
            min-width: 250px;
        }
        
        .reset-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }
        
        .reset-btn:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 25px 50px rgba(255, 65, 108, 0.5);
        }
        
        .reset-btn:hover:before {
            left: 100%;
        }
        
        .progress-section {
            margin-top: 40px;
            display: none;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 35px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: inset 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #00b09b, #96c93d);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            text-align: center;
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }
        
        .error-section {
            background: linear-gradient(135deg, rgba(255, 65, 108, 0.1) 0%, rgba(255, 75, 43, 0.1) 100%);
            color: #ff416c;
            border: 3px solid #ff416c;
            border-radius: 15px;
            padding: 30px;
            margin-top: 40px;
            display: none;
            animation: pulse 2s infinite;
            backdrop-filter: blur(10px);
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(255, 65, 108, 0); }
        }
        
        .error-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .error-title:before {
            content: "‚ö†Ô∏è";
            font-size: 24px;
        }
        
        .error-message {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 18px;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.6;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(255, 65, 108, 0.3);
        }
        
        .close-error {
            float: right;
            background: none;
            border: none;
            color: #ff416c;
            cursor: pointer;
            font-size: 32px;
            line-height: 1;
            padding: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-error:hover {
            background-color: rgba(255, 65, 108, 0.1);
            transform: rotate(90deg);
        }
        
        .results-section {
            padding: 50px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 50px;
            opacity: 0;
            transform: translateY(50px);
            animation: slideUp 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .result-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(90deg, #667eea, #764ba2, #00b09b, #96c93d);
        }
        
        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card h2 {
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 3px solid rgba(102, 126, 234, 0.1);
        }
        
        .result-card h2:before {
            content: "‚ú®";
            font-size: 1.8rem;
        }
        
        .highlighted-text {
            font-family: Arial, sans-serif;
            line-height: 2.2;
            padding: 35px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            border: 2px solid rgba(102, 126, 234, 0.2);
            overflow-wrap: break-word;
            font-size: 20px;
            box-shadow: inset 0 8px 32px rgba(0, 0, 0, 0.05);
            min-height: 300px;
        }
        
        .entity {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px;
            margin: 8px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            color: white;
            font-size: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .entity:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }
        
        .entity-task {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
        }
        
        .entity-condition {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4);
        }
        
        .entity-task-info {
            background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
            box-shadow: 0 6px 20px rgba(255, 179, 71, 0.4);
        }
        
        .entity-o {
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
            color: #333;
            box-shadow: 0 6px 20px rgba(142, 158, 171, 0.4);
        }
        
        .entity-label {
            font-size: 0.8em;
            opacity: 0.9;
            margin-left: 8px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .plantuml-text {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6ff;
            padding: 25px;
            border-radius: 15px;
            overflow-x: auto;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
            border: 3px solid rgba(102, 126, 234, 0.3);
            box-shadow: inset 0 8px 32px rgba(0, 0, 0, 0.3);
            min-height: 250px;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .plantuml-text::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .plantuml-text::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .plantuml-text::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        /* –ë–û–õ–¨–®–ò–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´ –î–õ–Ø –î–ò–ê–ì–†–ê–ú–ú */
        .visualization {
            width: 100%;
            height: 900px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-radius: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 10px 50px rgba(0, 0, 0, 0.05);
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–†–´ –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ô –ó–ê–ù–ò–ú–ê–Æ–¢ –í–°–Æ –û–ë–õ–ê–°–¢–¨ */
        .heatmap-container, 
        .sankey-container, 
        .plantuml-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–†–´ –î–õ–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô PLANTUML */
        .plantuml-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .matrix-display {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            overflow-x: auto;
            margin-bottom: 30px;
            font-size: 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: inset 0 5px 20px rgba(0, 0, 0, 0.05);
            min-height: 250px;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid rgba(102, 126, 234, 0.1);
        }
        
        .visualization-title {
            font-size: 24px;
            color: #2c3e50;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .visualization-controls {
            display: flex;
            gap: 10px;
        }
        
        .visualization-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .visualization-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
        }
        
        .visualization-btn.download {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .visualization-btn.download:hover {
            box-shadow: 0 10px 25px rgba(0, 176, 155, 0.6);
        }
        
        .status-message {
            padding: 20px;
            margin: 30px 0;
            border-radius: 15px;
            display: none;
            font-size: 18px;
            font-weight: 600;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .status-loading {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #667eea;
            border-color: #667eea;
        }
        
        .status-error {
            background: linear-gradient(135deg, rgba(255, 65, 108, 0.2) 0%, rgba(255, 75, 43, 0.2) 100%);
            color: #ff416c;
            border-color: #ff416c;
        }
        
        .status-success {
            background: linear-gradient(135deg, rgba(0, 176, 155, 0.2) 0%, rgba(150, 201, 61, 0.2) 100%);
            color: #00b09b;
            border-color: #00b09b;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .url-link {
            display: block;
            margin-top: 15px;
            color: white;
            word-break: break-all;
            text-decoration: none;
            font-size: 14px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .url-link:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
            text-decoration: none;
        }
        
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .fullscreen-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 15px;
            width: 98%;
            height: 98%;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(102, 126, 234, 0.5);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
        }
        
        .close-fullscreen {
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 22px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.6);
        }
        
        .close-fullscreen:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 15px 30px rgba(255, 65, 108, 0.8);
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò */
        @media (max-width: 1600px) {
            .main-container {
                padding: 20px;
            }
            
            .visualization {
                height: 800px;
            }
        }
        
        @media (max-width: 1200px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .input-section, .result-card {
                padding: 30px;
            }
            
            .visualization {
                height: 700px;
            }
            
            .visualization-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .visualization-controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                padding: 30px 0 15px;
            }
            
            .input-section, .result-card {
                padding: 20px;
            }
            
            .test-btn, .process-btn, .reset-btn {
                padding: 15px 20px;
                font-size: 16px;
                min-width: auto;
            }
            
            .main-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .visualization {
                height: 600px;
            }
            
            .plantuml-text {
                min-height: 200px;
                max-height: 300px;
            }
            
            .highlighted-text {
                min-height: 250px;
            }
            
            .result-card h2 {
                font-size: 1.5rem;
            }
            
            .visualization-btn {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .highlighted-text {
                padding: 20px;
                font-size: 16px;
                min-height: 200px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.6rem;
            }
            
            .main-container {
                padding: 10px;
            }
            
            .input-section h2, .result-card h2 {
                font-size: 1.3rem;
            }
            
            .visualization {
                height: 500px;
            }
            
            .plantuml-text, .matrix-display {
                padding: 10px;
                font-size: 12px;
                min-height: 150px;
                max-height: 250px;
            }
            
            .highlighted-text {
                min-height: 200px;
            }
            
            .visualization-header {
                margin-bottom: 15px;
            }
            
            .visualization-controls {
                gap: 5px;
            }
            
            .visualization-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .url-link {
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- PlantUML Encoder -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="background-wrapper"></div>
    
    <div class="main-container">
        <div class="glass-card">
            <h1><i class="fas fa-project-diagram"></i> UML Process Visualizer</h1>
            
            <div class="input-section">
                <h2><i class="fas fa-keyboard"></i> Enter Process Description</h2>
                
                <div class="test-buttons">
                    <button class="test-btn" data-test="1">
                        <i class="fas fa-file-alt"></i> Test 1: Simple Process
                    </button>
                    <button class="test-btn" data-test="2">
                        <i class="fas fa-code-branch"></i> Test 2: Conditional Process
                    </button>
                    <button class="test-btn" data-test="3">
                        <i class="fas fa-users"></i> Test 3: Complex Multi-participant
                    </button>
                </div>
                
                <textarea id="process-text" placeholder="Describe your business process here... 
Example: Employee submits a vacation request. Manager reviews the request. If approved, HR department processes the vacation. Otherwise, manager informs the employee."></textarea>
                
                <div class="main-buttons">
                    <button id="process-btn" class="process-btn">
                        <i class="fas fa-play-circle"></i> Process Text
                    </button>
                    <button id="reset-btn" class="reset-btn">
                        <i class="fas fa-redo"></i> Reset All
                    </button>
                </div>
                
                <div class="progress-section" id="progress-section">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Processing...</div>
                </div>
                
                <div class="error-section" id="error-section">
                    <button class="close-error" id="close-error">√ó</button>
                    <div class="error-title">
                        <i class="fas fa-exclamation-triangle"></i> Error
                    </div>
                    <div class="error-message" id="error-message"></div>
                </div>
            </div>
            
            <div id="status-message" class="status-message"></div>
            
            <div class="results-section">
                <div id="result-highlighting" class="result-card" style="display: none;">
                    <h2><i class="fas fa-highlighter"></i> ENTITY HIGHLIGHTING</h2>
                    <div id="highlighted-text" class="highlighted-text">
                        <!-- Entity highlighting will appear here -->
                    </div>
                </div>
                
                <div id="result-plantuml" class="result-card" style="display: none;">
                    <div class="visualization-header">
                        <h2><i class="fas fa-sitemap"></i> PLANTUML UML DIAGRAM</h2>
                        <div class="visualization-controls">
                            <button class="visualization-btn" onclick="toggleFullscreen('plantuml-image')">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button class="visualization-btn" onclick="refreshPlantUML()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="visualization-btn download" onclick="downloadPlantUML()">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div id="plantuml-text" class="plantuml-text"></div>
                    <div id="plantuml-image" class="visualization">
                        <!-- PlantUML image will appear here -->
                    </div>
                    <a id="plantuml-url" class="url-link" href="#" target="_blank" style="display: none;">
                        <i class="fas fa-external-link-alt"></i> Open PlantUML diagram in new tab
                    </a>
                </div>
                
                <div id="result-heatmap" class="result-card" style="display: none;">
                    <div class="visualization-header">
                        <h2><i class="fas fa-fire"></i> INTERACTION MATRIX & HEATMAP</h2>
                        <div class="visualization-controls">
                            <button class="visualization-btn" onclick="toggleFullscreen('heatmap-visualization')">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button class="visualization-btn download" onclick="downloadHeatmap()">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div id="matrix-text" class="matrix-display"></div>
                    <div id="heatmap-visualization" class="visualization">
                        <!-- Heatmap will appear here -->
                    </div>
                </div>
                
                <div id="result-sankey" class="result-card" style="display: none;">
                    <div class="visualization-header">
                        <h2><i class="fas fa-water"></i> SANKEY DIAGRAM</h2>
                        <div class="visualization-controls">
                            <button class="visualization-btn" onclick="toggleFullscreen('sankey-visualization')">
                                <i class="fas fa-expand"></i> Fullscreen
                            </button>
                            <button class="visualization-btn download" onclick="downloadSankey()">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div id="sankey-visualization" class="visualization">
                        <!-- Sankey diagram will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen overlay -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        <div class="fullscreen-content" id="fullscreen-content"></div>
    </div>

   <script>
    // Test data in English
    const testCases = {
        1: `Employee submits a vacation request. Manager reviews the request. If approved, HR department processes the vacation. Otherwise, manager informs the employee.`,
        
        2: `Customer submits a product return request. Support service checks the request. If product meets return conditions, finance department approves refund, system processes payment. Otherwise, support service informs customer about rejection.`,
        
        3: `Customer sends development request. Project manager analyzes the request. If request matches company capabilities, sales department prepares commercial proposal, technical department estimates timelines. If proposal accepted, development department starts work, testers verify result. Otherwise, project manager informs customer about refusal.`
    };

    // Initialize test buttons
    document.querySelectorAll('.test-btn').forEach(button => {
        button.addEventListener('click', function() {
            const testNumber = this.getAttribute('data-test');
            document.getElementById('process-text').value = testCases[testNumber];
            showStatus(`Loaded test case ${testNumber}`, 'success');
            // Animate button
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });

    // Process button
    document.getElementById('process-btn').addEventListener('click', processText);
    
    // Reset button
    document.getElementById('reset-btn').addEventListener('click', resetApp);
    
    // Close error button
    document.getElementById('close-error').addEventListener('click', () => {
        document.getElementById('error-section').style.display = 'none';
    });
    
    // Fullscreen functions
    function toggleFullscreen(elementId) {
        const element = document.getElementById(elementId);
        const overlay = document.getElementById('fullscreen-overlay');
        const content = document.getElementById('fullscreen-content');
        
        content.innerHTML = element.innerHTML;
        
        // Adjust for fullscreen
        const images = content.querySelectorAll('img');
        images.forEach(img => {
            img.style.maxWidth = '100%';
            img.style.maxHeight = '90vh';
            img.style.objectFit = 'contain';
        });
        
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Also show Plotly figures in fullscreen
        if (elementId === 'heatmap-visualization' || elementId === 'sankey-visualization') {
            setTimeout(() => {
                Plotly.Plots.resize(content);
            }, 100);
        }
    }
    
    function closeFullscreen() {
        const overlay = document.getElementById('fullscreen-overlay');
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Download functions
    function downloadPlantUML() {
        const url = document.getElementById('plantuml-url').href;
        if (url && url !== '#') {
            window.open(url, '_blank');
        }
    }
    
    function downloadHeatmap() {
        const plotDiv = document.getElementById('heatmap-visualization');
        if (plotDiv && plotDiv.querySelector('.plotly')) {
            Plotly.downloadImage(plotDiv, {
                format: 'png',
                height: 1200,
                width: 1600,
                filename: 'uml-heatmap'
            });
        }
    }
    
    function downloadSankey() {
        const plotDiv = document.getElementById('sankey-visualization');
        if (plotDiv && plotDiv.querySelector('.plotly')) {
            Plotly.downloadImage(plotDiv, {
                format: 'png',
                height: 1200,
                width: 1600,
                filename: 'uml-sankey'
            });
        }
    }
    
    // Refresh PlantUML
    function refreshPlantUML() {
        const plantumlText = document.getElementById('plantuml-text').textContent;
        if (plantumlText) {
            showPlantUML(plantumlText);
            showStatus('Diagram refreshed', 'success');
        }
    }
    
    // Function to process text
    async function processText() {
        const text = document.getElementById('process-text').value.trim();
        
        if (!text) {
            showError('Please enter process text');
            return;
        }
        
        // Reset previous state
        hideAllResults();
        hideError();
        hideStatus();
        
        // Show progress bar
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressSection.style.display = 'block';
        
        try {
            // Simulate processing with progress updates
            await simulateProcessing(progressBar, progressText);
            
            // Generate results
            generateDemoResults(text);
            
            // Show success
            showStatus('‚úÖ Processing completed successfully! Visualizations are ready.', 'success');
            
            // Scroll to results
            setTimeout(() => {
                document.querySelector('.results-section').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 500);
            
        } catch (error) {
            showError(`‚ùå Processing error: ${error.message}`);
        } finally {
            // Hide progress bar after delay
            setTimeout(() => {
                progressSection.style.display = 'none';
                progressBar.style.width = '0%';
            }, 500);
        }
    }
    
    // Simulate processing with progress
    async function simulateProcessing(progressBar, progressText) {
        const steps = [
            {percent: 10, text: "üìñ Parsing text structure..."},
            {percent: 25, text: "üîç Extracting entities and participants..."},
            {percent: 40, text: "üë• Identifying process relationships..."},
            {percent: 55, text: "üìä Generating UML diagram..."},
            {percent: 70, text: "üî• Creating interaction heatmap..."},
            {percent: 85, text: "üåä Generating Sankey flow diagram..."},
            {percent: 95, text: "üé® Finalizing visualizations..."},
            {percent: 100, text: "‚úÖ Complete! Rendering results..."}
        ];
        
        for (const step of steps) {
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 400));
            progressBar.style.width = step.percent + '%';
            progressText.textContent = step.text;
        }
    }
    
    // Show error
    function showError(message) {
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = message;
        errorSection.style.display = 'block';
        
        // Scroll to error
        errorSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'center'
        });
        
        // Auto-hide error after 15 seconds
        setTimeout(() => {
            errorSection.style.display = 'none';
        }, 15000);
    }
    
    // Hide error
    function hideError() {
        document.getElementById('error-section').style.display = 'none';
    }
    
    // Reset function
    function resetApp() {
        document.getElementById('process-text').value = '';
        hideAllResults();
        hideStatus();
        hideError();
        document.getElementById('progress-section').style.display = 'none';
        showStatus('üîÑ Application reset. Ready for new input.', 'success');
        setTimeout(hideStatus, 2000);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Hide all results
    function hideAllResults() {
        const resultCards = document.querySelectorAll('.result-card');
        resultCards.forEach(card => {
            card.style.display = 'none';
        });
    }
    
    // Show status
    function showStatus(message, type) {
        const statusEl = document.getElementById('status-message');
        statusEl.innerHTML = message;
        statusEl.className = `status-message status-${type}`;
        statusEl.style.display = 'block';
        
        if (type === 'loading') {
            statusEl.innerHTML = `<span class="loading-spinner"></span> ${message}`;
        }
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => {
                if (statusEl.className.includes('status-success')) {
                    hideStatus();
                }
            }, 5000);
        }
    }
    
    // Hide status
    function hideStatus() {
        document.getElementById('status-message').style.display = 'none';
    }

    // --------------------------
    // NLP / —Å—É—â–Ω–æ—Å—Ç–∏ / –≤–µ—Ç–≤–ª–µ–Ω–∏–µ
    // --------------------------

    // Extract entities from text
    function extractEntities(text) {
        const entities = [];
        const words = text.split(/\s+/);
        
        words.forEach(word => {
            const cleanWord = word.replace(/[.,]/g, '').toLowerCase();
            
            if (['department', 'service', 'employee', 'customer', 'manager', 'client', 'tester', 'project', 'team', 'system'].some(term => cleanWord.includes(term))) {
                entities.push({text: word, type: 'AGENT'});
            } else if (['submits', 'reviews', 'checks', 'analyzes', 'prepares', 'estimates', 'starts', 'processes', 'informs', 'verifies', 'sends', 'approves', 'accepts'].some(term => cleanWord.includes(term))) {
                entities.push({text: word, type: 'TASK'});
            } else if (['if', 'otherwise', 'when', 'then'].includes(cleanWord)) {
                entities.push({text: word, type: 'CONDITION'});
            } else {
                entities.push({text: word, type: 'O'});
            }
        });
        
        return entities;
    }

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø–∞–º –∏ —Å–∫–ª–µ–∏–≤–∞–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ —Å–ª–æ–≤–∞ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞ –≤ —Ñ—Ä–∞–∑—ã
    function groupEntities(entities) {
        const groups = {
            AGENT: [],
            TASK: [],
            CONDITION: []
        };
        
        let current = [];
        let currentType = null;
    
        function flush() {
            if (!currentType || current.length === 0) return;
            let phrase = current.join(' ').replace(/[.,]/g, '').trim();
            if (phrase && !groups[currentType].includes(phrase)) {
                groups[currentType].push(phrase);
            }
            current = [];
            currentType = null;
        }
    
        entities.forEach((e, idx) => {
            if (e.type === 'O') {
                flush();
                return;
            }
    
            if (e.type !== currentType && current.length) {
                flush();
            }
    
            currentType = e.type;
            current.push(e.text);
    
            if (idx === entities.length - 1) {
                flush();
            }
        });
    
        return groups;
    }

    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    function splitIntoSentences(text) {
        return text
            .split(/(?<=[.!?])\s+/)
            .map(s => s.trim())
            .filter(Boolean);
    }

    // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–¥–Ω—É —É—Å–ª–æ–≤–Ω—É—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: If ... Then ... Otherwise ...
    function extractConditionalStructure(text, agents) {
        const sentences = splitIntoSentences(text);
        const agentsLower = agents.map(a => a.toLowerCase());

        // –ò—â–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å "if"
        let ifIdx = -1;
        for (let i = 0; i < sentences.length; i++) {
            if (sentences[i].toLowerCase().includes('if ')) {
                ifIdx = i;
                break;
            }
        }
        if (ifIdx === -1) return null;

        // –ò—â–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å "otherwise" / "else" –ø–æ—Å–ª–µ if
        let elseIdx = -1;
        for (let j = ifIdx + 1; j < sentences.length; j++) {
            const lc = sentences[j].toLowerCase();
            if (lc.startsWith('otherwise') || lc.startsWith('else')) {
                elseIdx = j;
                break;
            }
        }

        const ifSentence = sentences[ifIdx];

        // then‚Äë–≤–µ—Ç–∫–∞: –ª–∏–±–æ —Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –ª–∏–±–æ —Å–∞–º–æ if‚Äë–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        let thenSentence = ifSentence;
        if (ifIdx + 1 < sentences.length && ifIdx + 1 !== elseIdx) {
            thenSentence = sentences[ifIdx + 1];
        }

        const elseSentence = elseIdx !== -1 ? sentences[elseIdx] : null;

        // –ü–æ–∏—Å–∫ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏
        function findAgentsInSentence(sentence) {
            const s = sentence.toLowerCase();
            const indices = [];
            agentsLower.forEach((a, idx) => {
                if (a && s.includes(a)) indices.push(idx);
            });
            return indices;
        }

        function choosePair(sentence) {
            const idxs = findAgentsInSentence(sentence);
            if (idxs.length >= 2) {
                return { from: idxs[0], to: idxs[1] };
            }
            if (idxs.length === 1) {
                const only = idxs[0];
                return { from: 0, to: only };
            }
            return { from: 0, to: Math.min(1, agents.length - 1) };
        }

        const condMatch = ifSentence.match(/if\s+([^,.!?]+)/i);
        const conditionLabel = condMatch ? condMatch[1].trim() : 'Condition';

        const thenPair = choosePair(thenSentence);
        const elsePair = elseSentence ? choosePair(elseSentence) : choosePair(ifSentence);

        return {
            conditionLabel,
            thenSentence,
            elseSentence,
            thenFrom: thenPair.from,
            thenTo: thenPair.to,
            elseFrom: elsePair.from,
            elseTo: elsePair.to
        };
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è PlantUML (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
    function escapePlantUMLLabel(label) {
        return label.replace(/"/g, '\\"');
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PlantUML-–¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å—É—â–Ω–æ—Å—Ç—è–º + —É—Å–ª–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
    function generatePlantUMLFromEntities(grouped, originalText) {
        const agentsRaw = grouped.AGENT || [];
        const tasksRaw = grouped.TASK || [];
        const hasConditionKeyword =
            (grouped.CONDITION && grouped.CONDITION.length > 0) ||
            originalText.toLowerCase().includes('if') ||
            originalText.toLowerCase().includes('otherwise');

        let uniqueAgents = [...new Set(
            agentsRaw.map(a => a.trim()).filter(a => a.length > 0)
        )].slice(0, 6);

        if (uniqueAgents.length === 0) {
            uniqueAgents = ['Employee', 'Manager', 'HR Department', 'Finance', 'Support', 'System'];
        }

        const cleanAgents = uniqueAgents.map(a =>
            a.length > 30 ? a.substring(0, 30) + '...' : a
        );

        const tasks = tasksRaw.map(t => t.trim()).filter(t => t.length > 0);

        const condStruct = hasConditionKeyword
            ? extractConditionalStructure(originalText, cleanAgents)
            : null;

        let plantuml = `@startuml\n`;
        plantuml += `!theme plain\n`;
        plantuml += `skinparam backgroundColor #FFFFFF\n`;
        plantuml += `skinparam sequence {\n`;
        plantuml += `  ArrowColor #667eea\n`;
        plantuml += `  ActorBorderColor #000000\n`;
        plantuml += `  ActorBackgroundColor #E1F5FE\n`;
        plantuml += `  ParticipantBorderColor #667eea\n`;
        plantuml += `  ParticipantBackgroundColor #F8F9FF\n`;
        plantuml += `  LifeLineBorderColor #667eea\n`;
        plantuml += `  LifeLineBackgroundColor #FFFFFF\n`;
        plantuml += `  ParticipantFontSize 16\n`;
        plantuml += `  ActorFontSize 16\n`;
        plantuml += `}\n\n`;

        plantuml += `title **<color:#667eea>UML Sequence Diagram</color>**\n`;
        plantuml += `caption Generated from: "${escapePlantUMLLabel(originalText.substring(0, 100))}${originalText.length > 100 ? '...' : ''}"\n\n`;

        cleanAgents.forEach((agent, idx) => {
            plantuml += `participant "<color:#667eea><b>${escapePlantUMLLabel(agent)}</b></color>" as P${idx}\n`;
        });
        plantuml += `\n`;

        const nAgents = cleanAgents.length;

        if (nAgents >= 2 && tasks.length > 0) {
            tasks.forEach((taskText, i) => {
                const from = i % nAgents;
                const to = (i + 1) % nAgents;
                const label = escapePlantUMLLabel(taskText.length > 80 ? taskText.substring(0, 80) + '...' : taskText);

                plantuml += `P${from} -> P${to} : **<color:#00b09b>${label}</color>**\n`;
                plantuml += `activate P${to}\n`;
            });
        } else if (nAgents >= 2) {
            plantuml += `P0 -> P1 : **<color:#00b09b>Process</color>**\n`;
            plantuml += `activate P1\n`;
        }

        if (condStruct) {
            plantuml += `\n`;
            const condLabelEsc = escapePlantUMLLabel(condStruct.conditionLabel);

            plantuml += `alt **<color:#667eea>${condLabelEsc}</color>**\n`;

            const thenShort = condStruct.thenSentence.length > 80
                ? condStruct.thenSentence.substring(0, 80) + '...'
                : condStruct.thenSentence;
            const thenLabel = escapePlantUMLLabel(thenShort);

            plantuml += `  P${condStruct.thenFrom} -> P${condStruct.thenTo} : **<color:#96c93d>${thenLabel}</color>**\n`;

            if (condStruct.elseSentence) {
                let elseText = condStruct.elseSentence
                    .replace(/^otherwise[,:\s]*/i, '')
                    .replace(/^else[,:\s]*/i, '')
                    .trim();
                if (!elseText) elseText = condStruct.elseSentence;

                const elseShort = elseText.length > 80 ? elseText.substring(0, 80) + '...' : elseText;
                const elseLabel = escapePlantUMLLabel(elseShort);

                plantuml += `else **<color:#ff416c>otherwise</color>**\n`;
                plantuml += `  P${condStruct.elseFrom} -> P${condStruct.elseTo} : **<color:#ff416c>${elseLabel}</color>**\n`;
            } else {
                plantuml += `else **<color:#ff416c>otherwise</color>**\n`;
                plantuml += `  P0 -> P0 : **<color:#ff416c>Alternative path</color>**\n`;
            }

            plantuml += `end\n`;
        } else if (hasConditionKeyword) {
            plantuml += `\n`;
            plantuml += `alt **<color:#667eea>Condition / approved</color>**\n`;
            if (nAgents >= 2) {
                plantuml += `  P1 -> P0 : **<color:#96c93d>Positive path</color>**\n`;
            } else {
                plantuml += `  P0 -> P0 : **<color:#96c93d>Positive path</color>**\n`;
            }
            plantuml += `else **<color:#ff416c>Condition / rejected</color>**\n`;
            if (nAgents >= 2) {
                plantuml += `  P1 -> P0 : **<color:#ff416c>Negative path</color>**\n`;
            } else {
                plantuml += `  P0 -> P0 : **<color:#ff416c>Negative path</color>**\n`;
            }
            plantuml += `end\n`;
        }

        plantuml += `\n@enduml`;

        return plantuml;
    }

    // Extract participants from text (fallback)
    function extractAgents(text) {
        const agents = [];
        const sentences = text.split(/[.,]/g);
        
        sentences.forEach(sentence => {
            if (sentence.includes('department') || sentence.includes('service') || sentence.includes('employee') || 
                sentence.includes('customer') || sentence.includes('manager') || sentence.includes('client') ||
                sentence.includes('project') || sentence.includes('team') || sentence.includes('system')) {
                
                const words = sentence.trim().split(/\s+/);
                if (words.length > 0) {
                    const agent = words.slice(0, Math.min(4, words.length)).join(' ');
                    if (agent && !agents.includes(agent)) {
                        agents.push(agent);
                    }
                }
            }
        });
        
        if (agents.length === 0) {
            return ['Employee', 'Manager', 'HR Department', 'Finance Department', 'Support Service'];
        }
        
        return agents;
    }

    // Show entity highlighting
    function showEntityHighlighting(entities) {
        const container = document.getElementById('highlighted-text');
        let html = '';
        
        let currentGroup = [];
        let currentType = null;
        
        entities.forEach((entity, index) => {
            if (entity.type !== currentType && currentGroup.length > 0) {
                html += createEntitySpan(currentGroup.join(' '), currentType);
                currentGroup = [];
            }
            
            currentGroup.push(entity.text);
            currentType = entity.type;
            
            if (index === entities.length - 1) {
                html += createEntitySpan(currentGroup.join(' '), currentType);
            }
        });
        
        container.innerHTML = html;
        document.getElementById('result-highlighting').style.display = 'block';
    }
    
    // Create entity span
    function createEntitySpan(text, type) {
        const typeClass = `entity-${type.toLowerCase()}`;
        const displayType = type !== 'O' ? type : '';
        const icon = type === 'AGENT' ? 'üë§' : type === 'TASK' ? '‚öôÔ∏è' : type === 'CONDITION' ? 'üîÄ' : '';
        
        return `
            <span class="entity ${typeClass}">
                ${icon} ${text}
                ${displayType ? `<span class="entity-label">${displayType}</span>` : ''}
            </span>
        `;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function generateDemoResults(text) {
        const entities = extractEntities(text);
        const grouped = groupEntities(entities);

        showEntityHighlighting(entities);

        const plantumlText = generatePlantUMLFromEntities(grouped, text);
        showPlantUML(plantumlText);

        let agents = grouped.AGENT && grouped.AGENT.length > 0
            ? grouped.AGENT
            : extractAgents(text);

        showInteractionMatrix(agents);
        generateHeatmap(agents);
        generateSankey(agents);
    }

    // Show PlantUML
    function showPlantUML(plantumlText) {
        document.getElementById('plantuml-text').textContent = plantumlText;
        
        try {
            const encoded = encodePlantUML(plantumlText);
            const url = `https://www.plantuml.com/plantuml/svg/${encoded}`;
            
            const imgContainer = document.getElementById('plantuml-image');
            imgContainer.innerHTML = `
                <div class="plantuml-image-container">
                    <img src="${url}" 
                         alt="UML Diagram"
                         onload="console.log('PlantUML loaded successfully')"
                         onerror="handlePlantUMLError(this, '${url}')">
                </div>
            `;
            
            const urlLink = document.getElementById("plantuml-url");
            urlLink.href = url;
            urlLink.style.display = "block";
            document.getElementById('result-plantuml').style.display = 'block';
            
        } catch (err) {
            console.error("PlantUML generation error:", err);
            document.getElementById('plantuml-image').innerHTML =
                `<div style="color:#ff416c; padding:20px;">‚ùå Error generating diagram: ${err.message}</div>`;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ PlantUML
    function handlePlantUMLError(img, url) {
        console.error('Error loading PlantUML image:', url);
        if (img && img.parentElement) {
            img.parentElement.innerHTML = `
                <div style="color:#ff416c; padding:20px;">
                    ‚ùå Error loading UML diagram from PlantUML server.
                </div>`;
        }
    }

    // CORRECT PlantUML encoding function
    function encodePlantUML(text) {
        const utf8 = new TextEncoder().encode(text);
        const compressed = pako.deflateRaw(utf8, { level: 9 });
        
        function encode6bit(b) {
            if (b < 10) return String.fromCharCode(48 + b);
            b -= 10;
            if (b < 26) return String.fromCharCode(65 + b);
            b -= 26;
            if (b < 26) return String.fromCharCode(97 + b);
            b -= 26;
            return b === 0 ? '-' : '_';
        }
        
        function append3bytes(b1, b2, b3) {
            const c1 = b1 >> 2;
            const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
            const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
            const c4 = b3 & 0x3F;
            return encode6bit(c1) + encode6bit(c2) + encode6bit(c3) + encode6bit(c4);
        }
        
        let result = "";
        for (let i = 0; i < compressed.length; i += 3) {
            const b1 = compressed[i];
            const b2 = i + 1 < compressed.length ? compressed[i + 1] : 0;
            const b3 = i + 2 < compressed.length ? compressed[i + 2] : 0;
            result += append3bytes(b1, b2, b3);
        }
        return result;
    }

    // Show interaction matrix
    function showInteractionMatrix(agents) {
        if (agents.length === 0) return;
        
        const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 3).join(' '));
        
        let matrixText = 'PARTICIPANTS: ' + cleanAgents.map((agent, i) => `P${i}=${agent}`).join(', ') + '\n\n';
        matrixText += 'INTERACTION MATRIX (0-10 interactions):\n\n';
        
        matrixText += '        ' + cleanAgents.map((_, i) => `P${i}`.padEnd(12)).join('') + '\n';
        matrixText += '       ‚îå' + '‚îÄ'.repeat(cleanAgents.length * 12 - 1) + '‚îê\n';
        
        for (let i = 0; i < cleanAgents.length; i++) {
            matrixText += `P${i}    ‚îÇ`;
            for (let j = 0; j < cleanAgents.length; j++) {
                const value = i === j ? '    -    ' : `    ${Math.floor(Math.random() * 11)}    `;
                matrixText += value;
            }
            matrixText += '‚îÇ\n';
        }
        
        matrixText += '       ‚îî' + '‚îÄ'.repeat(cleanAgents.length * 12 - 1) + '‚îò\n\n';
        matrixText += 'Legend: - = Self-interaction (0)\n';
        matrixText += '        Higher numbers = More interactions\n';
        
        document.getElementById('matrix-text').textContent = matrixText;
    }
    
    // Generate heatmap
    function generateHeatmap(agents) {
        if (agents.length === 0) {
            document.getElementById('result-heatmap').style.display = 'block';
            return;
        }
        
        try {
            const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 3).join(' '));
            
            const data = [];
            const annotations = [];
            
            for (let i = 0; i < cleanAgents.length; i++) {
                const row = [];
                for (let j = 0; j < cleanAgents.length; j++) {
                    const value = i === j ? 0 : Math.floor(Math.random() * 10);
                    row.push(value);
                    
                    if (value > 5) {
                        annotations.push({
                            x: cleanAgents[j],
                            y: cleanAgents[i],
                            text: value.toString(),
                            font: { color: 'white', size: 12, weight: 'bold' },
                            showarrow: false
                        });
                    }
                }
                data.push(row);
            }
            
            const trace = {
                z: data,
                x: cleanAgents,
                y: cleanAgents,
                type: 'heatmap',
                colorscale: [
                    [0, '#f7fbff'],
                    [0.1, '#deebf7'],
                    [0.2, '#c6dbef'],
                    [0.3, '#9ecae1'],
                    [0.4, '#6baed6'],
                    [0.5, '#4292c6'],
                    [0.6, '#2171b5'],
                    [0.7, '#08519c'],
                    [0.8, '#08306b'],
                    [1, '#000033']
                ],
                hoverongaps: false,
                showscale: true,
                colorbar: {
                    title: { text: 'Interactions', font: { size: 16 } },
                    titleside: 'right',
                    thickness: 20,
                    len: 0.9
                },
                hovertemplate: 'From: %{y}<br>To: %{x}<br>Interactions: %{z}<extra></extra>'
            };
            
            const container = document.getElementById('heatmap-visualization');
            const layout = {
                title: {
                    text: '<span style="font-size:20px; color:#667eea;">Participant Interaction Heatmap</span>',
                    font: { size: 20, color: '#2c3e50' }
                },
                xaxis: { 
                    title: { text: 'To Participant', font: { size: 16, color: '#667eea' } },
                    tickangle: -45,
                    tickfont: { size: 10 }
                },
                yaxis: { 
                    title: { text: 'From Participant', font: { size: 16, color: '#667eea' } },
                    autorange: 'reversed',
                    tickfont: { size: 10 }
                },
                width: container.offsetWidth,
                height: container.offsetHeight,
                margin: { t: 60, r: 80, b: 80, l: 100 },
                annotations: annotations,
                paper_bgcolor: 'rgba(255,255,255,0.1)',
                plot_bgcolor: 'rgba(255,255,255,0.1)'
            };
            
            container.innerHTML = '';
            const plotDiv = document.createElement('div');
            plotDiv.style.width = '100%';
            plotDiv.style.height = '100%';
            container.appendChild(plotDiv);
            Plotly.newPlot(plotDiv, [trace], layout);
            document.getElementById('result-heatmap').style.display = 'block';
            
            window.addEventListener('resize', function() {
                Plotly.Plots.resize(plotDiv);
            });
            
        } catch (error) {
            const container = document.getElementById('heatmap-visualization');
            container.innerHTML = `<div style="text-align:center; padding:15px; color:#ff416c">
                <div style="font-size: 30px; margin-bottom: 10px;">üî•</div>
                <h3 style="font-size: 16px;">Heatmap Error</h3>
                <p style="font-size: 14px;">${error.message}</p>
            </div>`;
            document.getElementById('result-heatmap').style.display = 'block';
        }
    }
    
    // Generate Sankey diagram
    function generateSankey(agents) {
        if (agents.length < 2) {
            document.getElementById('result-sankey').style.display = 'block';
            return;
        }
        
        try {
            const cleanAgents = agents.map(agent => agent.split(' ').slice(0, 3).join(' '));
            
            const sources = [];
            const targets = [];
            const values = [];
            
            for (let i = 0; i < cleanAgents.length - 1; i++) {
                sources.push(i);
                targets.push(i + 1);
                values.push(Math.floor(Math.random() * 30) + 20);
            }
            
            if (cleanAgents.length >= 3) {
                sources.push(0);
                targets.push(2);
                values.push(Math.floor(Math.random() * 25) + 10);
                
                sources.push(1);
                targets.push(cleanAgents.length - 1);
                values.push(Math.floor(Math.random() * 20) + 5);
            }
            
            if (cleanAgents.length >= 4) {
                sources.push(2);
                targets.push(0);
                values.push(Math.floor(Math.random() * 15) + 5);
            }
            
            const trace = {
                type: "sankey",
                orientation: "h",
                arrangement: "snap",
                node: {
                    pad: 30,
                    thickness: 25,
                    line: {
                        color: "black",
                        width: 2
                    },
                    label: cleanAgents,
                    color: ["#667eea", "#764ba2", "#00b09b", "#96c93d", "#ff416c", "#ff4b2b", "#ffb347", "#ffcc33"].slice(0, cleanAgents.length),
                    hovertemplate: '%{label}<br>Total flow: %{value}<extra></extra>',
                    x: cleanAgents.map((_, i) => i * (1 / (cleanAgents.length - 1))),
                    y: cleanAgents.map((_, i) => 0.1 + (i % 2) * 0.3)
                },
                link: {
                    source: sources,
                    target: targets,
                    value: values,
                    color: ["rgba(102, 126, 234, 0.6)", "rgba(118, 75, 162, 0.6)", "rgba(0, 176, 155, 0.6)", 
                            "rgba(150, 201, 61, 0.6)", "rgba(255, 65, 108, 0.6)", "rgba(255, 75, 43, 0.6)",
                            "rgba(255, 179, 71, 0.6)", "rgba(255, 204, 51, 0.6)"],
                    hovertemplate: 'From: %{source.label}<br>To: %{target.label}<br>Value: %{value}<extra></extra>'
                }
            };
            
            const container = document.getElementById('sankey-visualization');
            const layout = {
                title: {
                    text: '<span style="font-size:20px; color:#667eea;">Resource Flow Diagram (Sankey)</span>',
                    font: { size: 20, color: '#2c3e50' }
                },
                font: { size: 12, color: '#2c3e50' },
                width: container.offsetWidth,
                height: container.offsetHeight,
                margin: { t: 60, r: 40, b: 40, l: 100 },
                paper_bgcolor: 'rgba(255,255,255,0.1)',
                plot_bgcolor: 'rgba(255,255,255,0.1)'
            };
            
            container.innerHTML = '';
            const plotDiv = document.createElement('div');
            plotDiv.style.width = '100%';
            plotDiv.style.height = '100%';
            container.appendChild(plotDiv);
            Plotly.newPlot(plotDiv, [trace], layout);
            document.getElementById('result-sankey').style.display = 'block';
            
            window.addEventListener('resize', function() {
                Plotly.Plots.resize(plotDiv);
            });
            
        } catch (error) {
            const container = document.getElementById('sankey-visualization');
            container.innerHTML = `<div style="text-align:center; padding:15px; color:#ff416c">
                <div style="font-size: 30px; margin-bottom: 10px;">üåä</div>
                <h3 style="font-size: 16px;">Sankey Diagram Error</h3>
                <p style="font-size: 14px;">${error.message}</p>
            </div>`;
            document.getElementById('result-sankey').style.display = 'block';
        }
    }
    
    // Initialize with test text
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('process-text').value = testCases[1];
        
        setTimeout(() => {
            const textarea = document.getElementById('process-text');
            textarea.focus();
            textarea.style.transform = 'scale(1.02)';
            setTimeout(() => {
                textarea.style.transform = 'scale(1)';
            }, 300);
        }, 500);
    });
</script>

</body>
</html>





