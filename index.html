<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN Визуализатор</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .input-section {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .input-section h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.4rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .test-btn:hover {
            background-color: #2980b9;
        }
        
        textarea {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 20px;
        }
        
        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .process-btn {
            padding: 12px 30px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .process-btn:hover {
            background-color: #27ae60;
        }
        
        .reset-btn {
            padding: 12px 30px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        .results-section {
            margin-top: 40px;
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .result-card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-card h2:before {
            content: "►";
            color: #3498db;
            font-size: 0.9em;
        }
        
        .highlighted-text {
            font-family: Arial, sans-serif;
            line-height: 2.0;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            overflow-wrap: break-word;
        }
        
        .entity {
            background-color: #7FDBFF;
            padding: 4px 8px;
            margin: 4px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .entity-task {
            background-color: #FFDC00;
        }
        
        .entity-condition {
            background-color: #FF851B;
        }
        
        .entity-task-info {
            background-color: #2ECC40;
        }
        
        .entity-o {
            background-color: #DDDDDD;
        }
        
        .entity-label {
            font-size: 0.8em;
            opacity: 0.6;
        }
        
        .plantuml-text {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .visualization-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .visualization {
            width: 100%;
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }
        
        .visualization-placeholder {
            color: #7f8c8d;
            text-align: center;
            padding: 40px;
        }
        
        .status-message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            display: none;
        }
        
        .status-loading {
            background-color: #e8f4fd;
            color: #3498db;
            border: 1px solid #3498db;
        }
        
        .status-error {
            background-color: #fde8e8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status-success {
            background-color: #e8f8ef;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .url-link {
            display: block;
            margin-top: 15px;
            color: #3498db;
            word-break: break-all;
            text-decoration: none;
        }
        
        .url-link:hover {
            text-decoration: underline;
        }
        
        .heatmap-container, .sankey-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .matrix-display {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .test-buttons, .main-buttons {
                flex-direction: column;
            }
            
            .test-btn, .process-btn, .reset-btn {
                width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .input-section, .result-card {
                padding: 15px;
            }
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>BPMN Визуализатор процессов</h1>
        
        <div class="input-section">
            <h2>Введите текст процесса:</h2>
            
            <div class="test-buttons">
                <button class="test-btn" data-test="1">Тест 1: Простой процесс</button>
                <button class="test-btn" data-test="2">Тест 2: Условный процесс</button>
                <button class="test-btn" data-test="3">Тест 3: Сложный процесс с несколькими участниками</button>
            </div>
            
            <textarea id="process-text" placeholder="Введите описание бизнес-процесса здесь..."></textarea>
            
            <div class="main-buttons">
                <button id="process-btn" class="process-btn">Обработать текст</button>
                <button id="reset-btn" class="reset-btn">Сбросить</button>
            </div>
        </div>
        
        <div id="status-message" class="status-message"></div>
        
        <div class="results-section">
            <div id="result-highlighting" class="result-card" style="display: none;">
                <h2>=== ENTITY HIGHLIGHTING ===</h2>
                <div id="highlighted-text" class="highlighted-text">
                    Результат подсветки сущностей появится здесь...
                </div>
            </div>
            
            <div id="result-plantuml" class="result-card" style="display: none;">
                <h2>=== PLANTUML BPMN ===</h2>
                <div id="plantuml-text" class="plantuml-text"></div>
                <div id="plantuml-image" class="visualization">
                    <div class="visualization-placeholder">
                        BPMN диаграмма будет отображена здесь
                    </div>
                </div>
                <a id="plantuml-url" class="url-link" href="#" target="_blank" style="display: none;"></a>
            </div>
            
            <div id="result-heatmap" class="result-card" style="display: none;">
                <h2>=== INTERACTION MATRIX + HEATMAP ===</h2>
                <div id="matrix-text" class="matrix-display"></div>
                <div id="heatmap-visualization" class="visualization">
                    <div class="visualization-placeholder">
                        Тепловая карта взаимодействий будет отображена здесь
                    </div>
                </div>
            </div>
            
            <div id="result-sankey" class="result-card" style="display: none;">
                <h2>=== SANKEY ===</h2>
                <div id="sankey-visualization" class="visualization">
                    <div class="visualization-placeholder">
                        Sankey диаграмма будет отображена здесь
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Тестовые данные
        const testCases = {
            1: `Сотрудник отправляет заявку на отпуск. Менеджер проверяет заявку. Если заявка одобрена, отдел кадров оформляет отпуск. Иначе менеджер информирует сотрудника.`,
            
            2: `Клиент отправляет заявку на возврат товара. Служба поддержки проверяет заявку. Если товар соответствует условиям возврата, финансовая служба одобряет возврат, система обрабатывает платеж. Иначе служба поддержки информирует клиента об отказе.`,
            
            3: `Заказчик отправляет запрос на разработку. Менеджер проекта анализирует запрос. Если запрос соответствует возможностям компании, отдел продаж готовит коммерческое предложение, технический отдел оценивает сроки. Если предложение принято, отдел разработки начинает работу, тестировщики проверяют результат. Иначе менеджер проекта информирует заказчика об отказе.`
        };

        // Инициализация тестовых кнопок
        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', function() {
                const testNumber = this.getAttribute('data-test');
                document.getElementById('process-text').value = testCases[testNumber];
                showStatus(`Загружен тестовый пример ${testNumber}`, 'success');
            });
        });

        // Кнопка обработки
        document.getElementById('process-btn').addEventListener('click', processText);
        
        // Кнопка сброса
        document.getElementById('reset-btn').addEventListener('click', resetApp);
        
        // Функция обработки текста
        function processText() {
            const text = document.getElementById('process-text').value.trim();
            
            if (!text) {
                showStatus('Пожалуйста, введите текст процесса', 'error');
                return;
            }
            
            showStatus('Обработка текста...', 'loading');
            
            // Скрываем предыдущие результаты
            hideAllResults();
            
            // Эмулируем обработку (в реальном приложении здесь будет вызов API или WebSocket)
            setTimeout(() => {
                // Генерируем демо-результаты на основе текста
                generateDemoResults(text);
                showStatus('Обработка завершена успешно!', 'success');
            }, 1500);
        }
        
        // Функция сброса
        function resetApp() {
            document.getElementById('process-text').value = '';
            hideAllResults();
            hideStatus();
            showStatus('Приложение сброшено', 'success');
            setTimeout(hideStatus, 2000);
        }
        
        // Функция скрытия всех результатов
        function hideAllResults() {
            const resultCards = document.querySelectorAll('.result-card');
            resultCards.forEach(card => {
                card.style.display = 'none';
            });
        }
        
        // Функция показа статуса
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'loading') {
                statusEl.innerHTML = `<span class="loading-spinner"></span> ${message}`;
            }
        }
        
        // Функция скрытия статуса
        function hideStatus() {
            document.getElementById('status-message').style.display = 'none';
        }
        
        // Генерация демо-результатов
        function generateDemoResults(text) {
            // Анализируем текст для извлечения сущностей
            const entities = extractEntities(text);
            
            // Показываем результат подсветки сущностей
            showEntityHighlighting(entities);
            
            // Генерируем PlantUML текст
            const plantumlText = generatePlantUML(text);
            showPlantUML(plantumlText);
            
            // Генерируем матрицу взаимодействий и тепловую карту
            const agents = extractAgents(text);
            showInteractionMatrix(agents);
            generateHeatmap(agents);
            
            // Генерируем Sankey диаграмму
            generateSankey(agents);
        }
        
        // Извлечение сущностей из текста (упрощенная версия)
        function extractEntities(text) {
            const entities = [];
            const words = text.split(/\s+/);
            
            // Простая логика извлечения сущностей
            words.forEach(word => {
                const cleanWord = word.replace(/[.,]/g, '').toLowerCase();
                
                if (['отдел', 'служба', 'сотрудник', 'клиент', 'менеджер', 'заказчик'].some(term => cleanWord.includes(term))) {
                    entities.push({text: word, type: 'AGENT'});
                } else if (['проверяет', 'отправляет', 'анализирует', 'готовит', 'оценивает', 'начинает', 'оформляет', 'обрабатывает', 'информирует'].some(term => cleanWord.includes(term))) {
                    entities.push({text: word, type: 'TASK'});
                } else if (['если', 'иначе'].includes(cleanWord)) {
                    entities.push({text: word, type: 'CONDITION'});
                } else {
                    entities.push({text: word, type: 'O'});
                }
            });
            
            return entities;
        }
        
        // Извлечение участников из текста
        function extractAgents(text) {
            const agents = [];
            const sentences = text.split(/[.,]/g);
            
            sentences.forEach(sentence => {
                if (sentence.includes('отдел') || sentence.includes('служба') || sentence.includes('сотрудник') || 
                    sentence.includes('клиент') || sentence.includes('менеджер') || sentence.includes('заказчик')) {
                    
                    // Упрощенное извлечение агента
                    const words = sentence.trim().split(/\s+/);
                    if (words.length > 0) {
                        // Берем первые 2-3 слова как агента
                        const agent = words.slice(0, Math.min(3, words.length)).join(' ');
                        if (agent && !agents.includes(agent)) {
                            agents.push(agent);
                        }
                    }
                }
            });
            
            // Если агентов не найдено, создаем демо-агентов
            if (agents.length === 0) {
                return ['Сотрудник', 'Менеджер', 'Отдел кадров', 'Финансовая служба'];
            }
            
            return agents;
        }
        
        // Показать подсветку сущностей
        function showEntityHighlighting(entities) {
            const container = document.getElementById('highlighted-text');
            let html = '';
            
            // Группируем сущности для лучшего отображения
            let currentGroup = [];
            let currentType = null;
            
            entities.forEach((entity, index) => {
                if (entity.type !== currentType && currentGroup.length > 0) {
                    html += createEntitySpan(currentGroup.join(' '), currentType);
                    currentGroup = [];
                }
                
                currentGroup.push(entity.text);
                currentType = entity.type;
                
                // Если это последняя сущность, выводим группу
                if (index === entities.length - 1) {
                    html += createEntitySpan(currentGroup.join(' '), currentType);
                }
            });
            
            container.innerHTML = html;
            document.getElementById('result-highlighting').style.display = 'block';
        }
        
        // Создать span для сущности
        function createEntitySpan(text, type) {
            const typeClass = `entity-${type.toLowerCase()}`;
            const displayType = type !== 'O' ? type : '';
            
            return `
                <span class="entity ${typeClass}">
                    ${text}
                    ${displayType ? `<span class="entity-label">${displayType}</span>` : ''}
                </span>
            `;
        }
        
        // Генерация PlantUML текста
        function generatePlantUML(text) {
            const agents = extractAgents(text);
            const hasCondition = text.toLowerCase().includes('если') || text.toLowerCase().includes('иначе');
            
            let plantuml = `@startuml\n`;
            
            agents.forEach(agent => {
                plantuml += `|${agent}|\n`;
                plantuml += `:действие ${agent.toLowerCase()};\n`;
            });
            
            if (hasCondition) {
                plantuml += `if (условие?) then (да)\n`;
                plantuml += `:действие при выполнении условия;\n`;
                plantuml += `else (нет)\n`;
                plantuml += `:действие при невыполнении условия;\n`;
                plantuml += `endif\n`;
            }
            
            plantuml += `stop\n`;
            plantuml += `@enduml`;
            
            return plantuml;
        }
        
        // Показать PlantUML
        function showPlantUML(plantumlText) {
            document.getElementById('plantuml-text').textContent = plantumlText;
            
            // Генерируем URL для PlantUML изображения (демо-версия)
            const encoded = btoa(plantumlText).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            const url = `https://www.plantuml.com/plantuml/svg/${encoded}`;
            
            // Создаем изображение
            const imgContainer = document.getElementById('plantuml-image');
            imgContainer.innerHTML = `<img src="${url}" alt="BPMN диаграмма" style="max-width:100%;">`;
            
            // Показываем ссылку
            const urlLink = document.getElementById('plantuml-url');
            urlLink.href = url;
            urlLink.textContent = url;
            urlLink.style.display = 'block';
            
            document.getElementById('result-plantuml').style.display = 'block';
        }
        
        // Показать матрицу взаимодействий
        function showInteractionMatrix(agents) {
            if (agents.length === 0) return;
            
            // Создаем демо-матрицу
            let matrixText = 'Agents: ' + agents.join(', ') + '\n\n';
            matrixText += 'Matrix:\n';
            
            for (let i = 0; i < agents.length; i++) {
                let row = '';
                for (let j = 0; j < agents.length; j++) {
                    if (i === j) {
                        row += ' 0';
                    } else {
                        // Случайные значения для демо
                        row += ' ' + Math.floor(Math.random() * 3);
                    }
                }
                matrixText += '[' + row + ' ]\n';
            }
            
            document.getElementById('matrix-text').textContent = matrixText;
        }
        
        // Генерация тепловой карты
        function generateHeatmap(agents) {
            if (agents.length === 0) {
                document.getElementById('result-heatmap').style.display = 'block';
                return;
            }
            
            // Создаем демо-данные для тепловой карты
            const data = [];
            for (let i = 0; i < agents.length; i++) {
                const row = [];
                for (let j = 0; j < agents.length; j++) {
                    if (i === j) {
                        row.push(0);
                    } else {
                        row.push(Math.floor(Math.random() * 5));
                    }
                }
                data.push(row);
            }
            
            const trace = {
                z: data,
                x: agents,
                y: agents,
                type: 'heatmap',
                colorscale: 'Viridis'
            };
            
            const layout = {
                title: 'Resource Interaction Heatmap',
                xaxis: { title: 'To Agent' },
                yaxis: { title: 'From Agent' },
                width: document.getElementById('heatmap-visualization').offsetWidth - 40,
                height: 400
            };
            
            Plotly.newPlot('heatmap-visualization', [trace], layout);
            document.getElementById('result-heatmap').style.display = 'block';
        }
        
        // Генерация Sankey диаграммы
        function generateSankey(agents) {
            if (agents.length < 2) {
                document.getElementById('result-sankey').style.display = 'block';
                return;
            }
            
            // Создаем демо-данные для Sankey
            const sources = [];
            const targets = [];
            const values = [];
            
            for (let i = 0; i < agents.length - 1; i++) {
                sources.push(i);
                targets.push(i + 1);
                values.push(Math.floor(Math.random() * 10) + 1);
            }
            
            // Добавляем несколько обратных связей для сложности
            if (agents.length > 2) {
                sources.push(agents.length - 1);
                targets.push(0);
                values.push(Math.floor(Math.random() * 5) + 1);
            }
            
            const trace = {
                type: "sankey",
                orientation: "h",
                node: {
                    pad: 15,
                    thickness: 20,
                    line: {
                        color: "black",
                        width: 0.5
                    },
                    label: agents,
                    color: ["#7FDBFF", "#FFDC00", "#FF851B", "#2ECC40", "#DDDDDD"].slice(0, agents.length)
                },
                link: {
                    source: sources,
                    target: targets,
                    value: values
                }
            };
            
            const layout = {
                title: "Resource Flow (Sankey Diagram)",
                font: { size: 12 },
                width: document.getElementById('sankey-visualization').offsetWidth - 40,
                height: 500
            };
            
            Plotly.newPlot('sankey-visualization', [trace], layout);
            document.getElementById('result-sankey').style.display = 'block';
        }
        
        // Инициализация с тестовым текстом
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('process-text').value = testCases[1];
        });
    </script>
</body>
</html>